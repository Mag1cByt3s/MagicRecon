#!/bin/bash

# Set workdir
WORKDIR=$(pwd)

log_info() {
    echo -e "\033[34m[INFO]\033[0m $1"
}

run_command() {
    log_info "Command: $1"
    eval "$1"
}

create_konsole_tab() {
    COMMAND=$1
    konsole --new-tab --workdir "$WORKDIR" -e $SHELL -c "$COMMAND; $SHELL"
}

identify_web_ports() {
    nmap_output="$1"
    excluded_ports="5357,5985,593,47001,49674"
    web_ports=()

    while IFS= read -r line; do
        if [[ "$line" =~ (http|ssl/http) ]]; then
            port=$(echo "$line" | grep -oP '^\d+/tcp' | cut -d '/' -f 1)
            if ! echo "$excluded_ports" | grep -q "$port"; then
                web_ports+=("$port")
            fi
        fi
    done <<< "$nmap_output"

    echo "${web_ports[@]}"
}

main() {
    target="$1"
    nmap_directory="$target/nmap"
    
    # Ensure the nmap directory exists
    mkdir -p "$nmap_directory"
    
    # Step 1: Run the initial Nmap scan to find open ports
    log_info "Running initial Nmap scan on target: $target"
    open_ports=$(sudo nmap -p- --min-rate=1000 -T4 "$target" | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed 's/,$//')
    
    if [ -z "$open_ports" ]; then
        log_info "No open ports found."
        return
    fi
    
    log_info "Detected open ports: $open_ports"
    
    # Step 2: Run the detailed Nmap scan on the detected open ports in a new Konsole tab
    detailed_nmap_command="sudo nmap -sC -sV --version-all -O -p$open_ports -vvv $target"
    create_konsole_tab "$detailed_nmap_command"
    
    # Step 3: Run the command to identify web ports in the current terminal
    detailed_nmap_output=$(sudo nmap -sC -sV --version-all -O -p"$open_ports" -vvv "$target")
    web_ports=$(identify_web_ports "$detailed_nmap_output")
    log_info "Identified web server ports (excluding certain ports): $web_ports"
    
    # Step 4: Display the results in a new Konsole tab
    display_command="echo \"$detailed_nmap_output\"; echo \"Identified web server ports: $web_ports\""
    create_konsole_tab "$display_command"
}

main "$@"
