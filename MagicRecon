#!/bin/bash

log_info() {
    echo "[INFO] $1"
}

run_command() {
    log_info "Command: $1"
    eval "$1"
}

create_byobu_session() {
    session_name=$1
    command=$2
    # Create a new Byobu session and run the command
    byobu new-session -d -s "$session_name" -n 'Nmap Scans' bash -c "$command; exec bash"
    sleep 1  # Give Byobu some time to initialize
}

attach_byobu_session() {
    session_name=$1
    byobu attach-session -t "$session_name"
}

identify_web_ports() {
    nmap_output="$1"
    excluded_ports="5357,5985,593,47001,49674"
    web_ports=()

    while IFS= read -r line; do
        if [[ "$line" =~ (http|ssl/http) ]]; then
            port=$(echo "$line" | grep -oP '^\d+/tcp' | cut -d '/' -f 1)
            if ! echo "$excluded_ports" | grep -q "$port"; then
                web_ports+=("$port")
            fi
        fi
    done <<< "$nmap_output"

    echo "${web_ports[@]}"
}

main() {
    session_name="recon_session"
    target="$1"
    nmap_directory="$target/nmap"
    
    # Ensure the nmap directory exists
    mkdir -p "$nmap_directory"
    
    # Step 1: Run the initial Nmap scan to find open ports
    log_info "Running initial Nmap scan on target: $target"
    open_ports=$(sudo nmap -p- --min-rate=1000 -T4 "$target" | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed 's/,$//')
    
    if [ -z "$open_ports" ]; then
        log_info "No open ports found."
        return
    fi
    
    log_info "Detected open ports: $open_ports"
    
    # Step 2: Run the detailed Nmap scan on the detected open ports
    detailed_nmap_output=$(sudo nmap -sC -sV --version-all -O -p"$open_ports" -vvv "$target")
    log_info "Detailed Nmap scan output:"
    echo "$detailed_nmap_output"
    
    # Step 3: Identify web ports from the detailed Nmap scan output
    web_ports=$(identify_web_ports "$detailed_nmap_output")
    log_info "Identified web server ports (excluding certain ports): $web_ports"
    
    # Step 4: Combine initial and detailed Nmap results
    combined_nmap_output="${detailed_nmap_output}"

    # Step 5: Start a Byobu session and display the combined Nmap output and web ports
    display_command="echo \"$combined_nmap_output\"; echo \"Identified web server ports: $web_ports\""
    create_byobu_session "$session_name" "$display_command"
    
    # Step 6: Attach to the Byobu session
    attach_byobu_session "$session_name"
}

main "$@"
